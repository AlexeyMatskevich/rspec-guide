---
description: Initialize plugin config. Run once in new Ruby project.
argument-hint: "[--force]"
---

# RSpec Init Command

One-time initialization. Creates configuration for rspec-testing plugin.

## Prerequisites

This command has NO prerequisites (it creates them for other commands).

## Execution Protocol

Create TodoWrite before starting:

- [Phase 1] Environment Detection
- [1.1] Check Ruby runtime
- [1.2] Parse Gemfile
- [1.3] Detect linter
- [1.4] Scan spec directory
- [1.5] Detect project type
- [Phase 2] Create Config
- [2.1] Create .claude/ directory
- [2.2] Generate config file
- [2.3] Ask metadata path
- [2.4] Ask controllers spec policy (Rails)
- [2.5] Create metadata folder
- [Phase 3] User Guidance
- [3.1] Show summary

## Phase 1: Environment Detection

### 1.1 Check Ruby

```bash
ruby --version
```

If Ruby not found:
```
Ruby runtime not found.

This plugin requires Ruby to analyze code and run tests.
Install Ruby and ensure it's in your PATH.
```

### 1.2 Parse Gemfile

Use Grep tool to search Gemfile:
- Pattern: `rspec|factory_bot|fabrication`
- File: `Gemfile`

Detect:
- `rspec-rails` or `rspec` → RSpec version
- `factory_bot_rails` or `factory_bot` → FactoryBot
- `fabrication` → Fabrication gem
- Neither → no factory library

### 1.3 Detect Linter

Use Glob tool to check for config files:
- Pattern: `.rubocop.yml` or `.rubocop_todo.yml` → RuboCop
- Pattern: `.standard.yml` → StandardRB
- Or Grep `standard` in Gemfile → StandardRB
- Neither → no linter configured

### 1.4 Scan Spec Directory

Use Glob tool to check spec structure:
- Pattern: `spec/*_helper.rb` → find spec_helper.rb or rails_helper.rb
- Pattern: `spec/factories/**/*` → check factories directory
- Pattern: `spec/support/**/*` → check support directory

Detect:
- `spec_helper.rb` vs `rails_helper.rb` (Rails project?)
- `spec/factories/` directory exists
- `spec/support/` directory exists

### 1.5 Detect Project Type

Determine project type (in priority order):

#### 1.5.1 Library Detection (FIRST)

Use Glob tool:
- Pattern: `*.gemspec`

If any `.gemspec` found → `library`

#### 1.5.2 Rails Detection (SECOND)

Use Grep tool:
- Pattern: `gem ['"]rails['"]|gem ['"]railties['"]`
- File: `Gemfile`

If found → `rails` (includes Rails API-only apps)

#### 1.5.3 Web Detection (THIRD)

**Step A: Framework gems**

Use Grep tool:
- Pattern: `gem ['"]roda['"]|gem ['"]hanami['"]|gem ['"]sinatra['"]`
- File: `Gemfile`

**Step B: API gems (if Step A fails)**

Use Grep tool:
- Pattern: `gem ['"]grape['"]|gem ['"]jsonapi-serializer['"]|gem ['"]jbuilder['"]`
- File: `Gemfile`

**Step C: Structure analysis (if Step B fails)**

Use Glob tool:
- Check `app/views/` exists → if NO views, likely API
- Check `app/controllers/` exists → has controllers

If any step matches → `web`

#### 1.5.4 Service Detection (FALLBACK)

Default if nothing else matches → `service`

**Project types (in detection order):**
- `library` — .gemspec exists → uses rspec
- `rails` — rails gem → uses rspec-rails
- `web` — roda/hanami/sinatra/grape → uses rspec
- `service` — fallback → uses rspec

## Phase 2: Create Config

### 2.1 Ensure .claude/ Directory Exists

```bash
mkdir -p .claude
```

### 2.2 Generate Config File

Create `.claude/rspec-testing-config.yml`:

Schema reference: `plugins/rspec-testing/docs/rspec-init-contract.md`.

```yaml
# RSpec Testing Plugin Configuration
# Generated by /rspec-init
#
# Reference from CLAUDE.md:
#   See .claude/rspec-testing-config.yml for RSpec plugin settings

ruby_version: "3.2.2"

project_type: rails  # library | rails | web | service

rspec:
  version: "3.12"
  helper: rails_helper  # or spec_helper

rails:
  controllers:
    # Where controller tests should live.
    # - request: always use request specs (recommended); prefer spec/requests and migrate away from spec/controllers
    # - controller: keep/update legacy controller specs under spec/controllers when present
    # - ask: ask per controller file when legacy exists
    spec_policy: request  # request | controller | ask

factory_gem: factory_bot  # or fabrication, or none

linter: rubocop  # or standardrb, or none

directories:
  spec: spec
  factories: spec/factories
  support: spec/support

metadata_path: tmp  # where pipeline stores intermediate metadata

initialized_at: "2024-01-15T10:30:00Z"
```

### 2.3 Ask for Metadata Path

Use AskUserQuestion to let user choose where to store pipeline metadata:

```
Where should the plugin store temporary metadata files?

Options:
- tmp (default) — project root tmp folder
- .claude/metadata — alongside plugin config
- Other — specify custom path
```

### 2.4 Ask Controllers Spec Policy (Rails Only)

If `project_type: rails`, use AskUserQuestion:

```
Rails controllers: where should controller tests be written?

Options:
- Request specs (recommended) — always use spec/requests; if legacy spec/controllers exist, migrate away (spec-writer deletes legacy controller specs as part of migration).
- Controller specs (legacy) — update spec/controllers when they already exist.
- Ask per controller file — decide only when legacy spec/controllers exist.
```

Write the choice to `.claude/rspec-testing-config.yml`:

```yaml
rails:
  controllers:
    spec_policy: request  # request | controller | ask
```

### 2.5 Create Metadata Folder

```bash
mkdir -p <chosen_path>
```

If folder creation fails, show error and suggest checking permissions.

## Phase 3: User Guidance

### 3.1 Show Summary

```
RSpec testing plugin initialized!

Config: .claude/rspec-testing-config.yml

Detected:
  Project type: rails
  Ruby:         3.2.2
  RSpec:        3.12
  Factory gem:  factory_bot
  Linter:       rubocop
  Spec helper:  rails_helper
  Controllers:  request specs

Directories:
  Specs:     spec/
  Factories: spec/factories/
  Metadata:  tmp/
```

## Re-initialization

If config already exists (without --force):

Use AskUserQuestion:
```
Config already exists: .claude/rspec-testing-config.yml

Options:
- Overwrite — re-detect everything, replace config
- Cancel — keep existing config
```

With `--force`: overwrite without asking.

## Error Handling

### No Gemfile Found

```
No Gemfile found in current directory.

This plugin is designed for Ruby projects with Bundler.
Ensure you're in the project root directory.
```

### No RSpec in Gemfile

```
RSpec not found in Gemfile.

Add RSpec to your Gemfile:
  gem 'rspec-rails', '~> 6.0'

Then run:
  bundle install
  rails generate rspec:install
```

### No spec/ Directory

```
No spec/ directory found.

Initialize RSpec first:
  bundle exec rails generate rspec:install

Or for non-Rails:
  bundle exec rspec --init
```

## Output Format

On success:

```yaml
status: success
config_file: .claude/rspec-testing-config.yml
detected:
  project_type: rails
  ruby_version: "3.2.2"
  rspec_version: "3.12"
  factory_gem: factory_bot
  linter: rubocop
  metadata_path: tmp
  rails:
    controllers:
      spec_policy: request
```

On error:

```yaml
status: error
error: "RSpec not found in Gemfile"
suggestion: "Add gem 'rspec-rails' to Gemfile and run bundle install"
```
